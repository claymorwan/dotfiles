{ lib, stdenv, fetchFromGitHub, kernel, kernelModuleMakeFlags, bc }:

stdenv.mkDerivation { # rec {
  pname = "rtl88x2bu";
  version = "unstable-2025-11-28";

  src = fetchFromGitHub {
  owner = "RinCat";
  repo = "RTL88x2BU-Linux-Driver";
  rev = "471877314bd3e4b4a02896a8ffa98fb09559c72f";
  hash = "sha256-P6MnpkWInsOwn9RhPmH7QbGqK7ezJlzp84q7GBoI41g=";
  };

  # sourceRoot = "source/" 
  hardeningDisable = [ "pic" "format" ];
  nativeBuildInputs = [ bc ] ++ kernel.moduleBuildDependencies;

  # preInstall = ''
  #   mkdir -p "$out/lib/modules/${kernel.modDirVersion}/kernel/drivers/net/wireless/"
  # '';

  makeFlags = kernelModuleMakeFlags;
  buildFlags = [ "KSRC=${kernel.dev}/lib/modules/${kernel.modDirVersion}/build" ];
  installFlags = [ "MODDESTDIR=${placeholder "out"}" ]; #/lib/modules/${kernel.modDirVersion}/kernel/drivers/net/wireless" ];
  # installPhase = ''
  #   install -p -m 644 *.ko $out/lib/modules/${kernel.modDirVersion}/misc/
  # '';

  meta = {
    description = "Realtek RTL88x2BU WiFi USB Driver for Linux";
    homepage = "https://github.com/RinCat/RTL88x2BU-Linux-Driver";
    license = [ lib.licenses.gpl2 ];
    platforms = [ "x86_64-linux" ];

  };

}
